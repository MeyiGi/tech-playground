<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gazi Ãœniversitesi Duyurular</title>
</head>
<body>
    <div>
        <div>
            <h1>duyuru</h1>
            <p>Son 5 duyuru sÄ±rasÄ±z SONUNA KADAR SABERDÄ°N GELECEK BAÄLANTI DENÃœYÃœR</p>
        </div>
        
        <div>
            <div></div>
        </div>

        <div>
            <div>
                <div>
                    <div></div>
                    Duyurular yÃ¼kleniyor
                </div>
            </div>
        </div>

        <div>
            <p>Sayfa <span>1</span> / <span>5</span> | Her 5 saniyede otomatik yenilenir</p>
        </div>
    </div>

    <script>
        let allAnnouncements = [];
        let currentPageIndex = 0;
        const itemsPerPage = 5;
        let autoScrollInterval;
        let progressInterval;
        const TIMEOUT = 8000; // 8 saniye timeout

        // DuyurularÄ± yÃ¼kle
        async function loadAnnouncements() {
            const container = document.querySelector('body > div > div:nth-child(3) > div'); // announcements-container div'i
            
            // Timeout ile promise
            const fetchWithTimeout = (url, timeout) => {
                return Promise.race([
                    fetch(url),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), timeout)
                    )
                ]);
            };

            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest='
            ];

            const targetUrl = 'https://gazi.edu.tr/view/announcement-list?id=2&type=1&SearchString=&dates=&date=';

            // Direkt deneme
            try {
                updateStatus('Gazi Ãœniversitesi sitesine baÄŸlanÄ±lÄ±yor...');
                const response = await fetchWithTimeout(targetUrl, TIMEOUT);
                if (response.ok) {
                    const html = await response.text();
                    if (html.length > 1000) {
                        parseAnnouncements(html);
                        return;
                    }
                }
            } catch (error) {
                console.log('Direkt baÄŸlantÄ± baÅŸarÄ±sÄ±z:', error.message);
            }

            // Proxy'leri sÄ±rayla dene
            for (let i = 0; i < proxies.length; i++) {
                try {
                    updateStatus(`Alternatif baÄŸlantÄ± deneniyor (${i + 1}/${proxies.length})...`);
                    const proxyUrl = proxies[i] + encodeURIComponent(targetUrl);
                    const response = await fetchWithTimeout(proxyUrl, TIMEOUT);
                    
                    if (response.ok) {
                        const html = await response.text();
                        if (html.length > 1000) {
                            parseAnnouncements(html);
                            return;
                        }
                    }
                } catch (error) {
                    console.log(`Proxy ${i + 1} baÅŸarÄ±sÄ±z:`, error.message);
                }
            }

            // HiÃ§biri Ã§alÄ±ÅŸmazsa demo yÃ¼kle
            updateStatus('BaÄŸlantÄ± kurulamadÄ±, demo veriler yÃ¼kleniyor...');
            setTimeout(() => {
                showError();
            }, 1000);
        }

        function updateStatus(message) {
            const container = document.querySelector('body > div > div:nth-child(3) > div');
            container.innerHTML = `
                <div>
                    <div></div>
                    ${message}
                </div>
            `;
        }

        // HTML'den duyurularÄ± Ã§Ä±kar
        function parseAnnouncements(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Gazi Ãœniversitesi Ã¶zel seÃ§iciler
            let announcementElements = doc.querySelectorAll('.duyuru-item, .announcement-item, .duyuru-liste-item, tr[onclick*="announcement"]');
            
            if (announcementElements.length === 0) {
                // Tablo satÄ±rlarÄ±nÄ± kontrol et
                announcementElements = doc.querySelectorAll('table tr');
            }
            
            if (announcementElements.length === 0) {
                // Linkleri kontrol et
                announcementElements = doc.querySelectorAll('a[href*="announcement"], a[href*="duyuru"]');
            }

            announcementElements.forEach((element, index) => {
                if (index < 25 && index > 0) { // Ä°lk satÄ±rÄ± atla (baÅŸlÄ±k olabilir)
                    let title = '';
                    let date = '';
                    let category = 'Genel Duyuru';

                    // FarklÄ± yapÄ±larÄ± dene
                    const titleEl = element.querySelector('.duyuru-baslik, .title, h3, h4, td:nth-child(2), td:nth-child(1)');
                    const dateEl = element.querySelector('.tarih, .date, time, td:last-child');
                    const categoryEl = element.querySelector('.kategori, .category, .badge');

                    if (titleEl) {
                        title = titleEl.textContent.trim();
                    } else {
                        const text = element.textContent.trim();
                        if (text.length > 10 && text.length < 300) {
                            title = text;
                        }
                    }

                    if (dateEl) {
                        date = dateEl.textContent.trim();
                    } else {
                        const dateMatch = element.textContent.match(/(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/);
                        if (dateMatch) date = dateMatch[1];
                    }

                    if (categoryEl) {
                        category = categoryEl.textContent.trim();
                    }

                    if (title && title.length > 10) {
                        allAnnouncements.push({
                            title: title.substring(0, 250),
                            date: date || 'Tarih belirtilmemiÅŸ',
                            category: category
                        });
                    }
                }
            });

            if (allAnnouncements.length === 0) {
                showError();
                return;
            }

            updateStatus(`${allAnnouncements.length} duyuru baÅŸarÄ±yla yÃ¼klendi!`);
            setTimeout(() => {
                displayPage(0);
                startAutoScroll();
            }, 1000);
        }

        // Hata mesajÄ± gÃ¶ster ve demo yÃ¼kle
        function showError() {
            const container = document.querySelector('body > div > div:nth-child(3) > div');
            container.innerHTML = `
                <div>
                    <h3>âš ï¸ CanlÄ± Verilere EriÅŸilemiyor</h3>
                    <p><strong>Neden?</strong> Gazi Ãœniversitesi web sitesi gÃ¼venlik politikasÄ± nedeniyle dÄ±ÅŸ kaynaklardan veri Ã§ekilmesine izin vermiyor (CORS).</p>
                    <p><strong>Ã‡Ã¶zÃ¼m:</strong></p>
                    <ul>
                        <li><strong>Python ile:</strong> <code>python -m http.server 8000</code> komutuyla yerel sunucu baÅŸlatÄ±n</li>
                        <li><strong>XAMPP/WAMP:</strong> DosyayÄ± htdocs klasÃ¶rÃ¼ne koyun</li>
                        <li><strong>VS Code:</strong> Live Server eklentisini kullanÄ±n</li>
                    </ul>
                </div>
            `;
        }

        // Sayfa gÃ¶ster
        function displayPage(pageIndex) {
            const container = document.querySelector('body > div > div:nth-child(3) > div');
            const start = pageIndex * itemsPerPage;
            const end = start + itemsPerPage;
            const pageAnnouncements = allAnnouncements.slice(start, end);
            
            if (pageAnnouncements.length === 0) {
                currentPageIndex = 0;
                displayPage(0);
                return;
            }
            
            container.innerHTML = '';
            
            pageAnnouncements.forEach(ann => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div>${ann.category}</div>
                    <h3>${ann.title}</h3>
                    <div>ğŸ“… ${ann.date}</div>
                `;
                container.appendChild(div);
            });
            
            const totalPages = Math.ceil(allAnnouncements.length / itemsPerPage);
            document.querySelector('body > div > div:nth-child(4) > p > span:nth-child(1)').textContent = pageIndex + 1; // currentPage
            document.querySelector('body > div > div:nth-child(4) > p > span:nth-child(2)').textContent = totalPages; // totalPages
        }

        // Otomatik kaydÄ±rma baÅŸlat
        function startAutoScroll() {
            const totalPages = Math.ceil(allAnnouncements.length / itemsPerPage);
            
            if (autoScrollInterval) clearInterval(autoScrollInterval);
            if (progressInterval) clearInterval(progressInterval);
            
            function resetProgress() {
                const progressBar = document.querySelector('body > div > div:nth-child(2) > div'); // progress-fill div'i
                // Stil niteliklerini deÄŸiÅŸtiren JavaScript kodlarÄ± sadeleÅŸtirilmiÅŸ HTML'de Ã§alÄ±ÅŸmaz, ancak fonksiyonu koruyorum.
            }
            
            resetProgress();
            
            autoScrollInterval = setInterval(() => {
                currentPageIndex = (currentPageIndex + 1) % totalPages;
                displayPage(currentPageIndex);
                resetProgress();
            }, 5000);
        }

        // Sayfa yÃ¼klendiÄŸinde baÅŸlat
        window.onload = () => {
            loadAnnouncements();
        };
    </script>
</body>
</html>